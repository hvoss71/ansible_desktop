---
# ======================================================================
# Playbook: uxplay-global-desktop-button.yml
# Zweck:    Erstellt systemweiten Starter für uxplay auf Cinnamon-Desktops
#           - Sichtbar auf allen Benutzer-Desktops
#           - Terminal bleibt geöffnet nach Programmstart
#           - Icon im Menü
# ======================================================================

- hosts: localhost
  connection: local
  become: true

  vars:
    uxplay_icon: "/usr/share/icons/hicolor/128x128/apps/uxplay.png"
    desktop_entry_system: "/usr/share/applications/uxplay-terminal.desktop"
    uxplay_exec: "/usr/bin/uxplay -n {{ ansible_hostname }} -nh"
    desktop_dirs:
      - Desktop
      - Schreibtisch
      - Arbeitsfläche

  tasks:

    # --------------------------------------------------------------
    # 1. Icon ins System kopieren
    # --------------------------------------------------------------
    - name: Kopiere uxplay-Icon
      ansible.builtin.copy:
        src: "files/uxplay.png"
        dest: "{{ uxplay_icon }}"
        mode: "0644"

    # --------------------------------------------------------------
    # 2. Systemweiten Starter im Menü anlegen
    # --------------------------------------------------------------
    - name: Erstelle systemweiten uxplay-Starter
      ansible.builtin.copy:
        dest: "{{ desktop_entry_system }}"
        content: |
          [Desktop Entry]
          Type=Application
          Name=AirPlay Receiver (Terminal)
          Comment=Starte uxplay im Terminal
          Exec=gnome-terminal -- bash -c "{{ uxplay_exec }}; echo; echo 'Drücken Sie [Enter], um das Terminal zu schließen...'; read"
          Icon={{ uxplay_icon }}
          Terminal=false
          Categories=AudioVideo;Network;
          StartupNotify=true
        mode: "0644"

    # --------------------------------------------------------------
    # 3. Starter auf Desktop-Ordnern bestehender Benutzer anlegen
    # --------------------------------------------------------------
    - name: Kopiere Starter auf Desktop-Ordner bestehender Benutzer
      ansible.builtin.shell: |
        for dir in /home/*; do
          for d in {{ desktop_dirs | join(' ') }}; do
            target="$dir/$d"
            if [ -d "$target" ] && [ -w "$target" ]; then
              cp -f "{{ desktop_entry_system }}" "$target/uxplay-terminal.desktop"
              chown $(basename "$dir"):$(basename "$dir") "$target/uxplay-terminal.desktop"
              chmod +x "$target/uxplay-terminal.desktop"
            fi
          done
        done
      args:
        executable: /bin/bash
      ignore_errors: true

    # --------------------------------------------------------------
    # 4. Starter in /etc/skel für neue Benutzer anlegen
    # --------------------------------------------------------------
    - name: Lege Desktop-Ordner in /etc/skel an
      ansible.builtin.file:
        path: "/etc/skel/{{ item }}"
        state: directory
        mode: "0755"
      loop: "{{ desktop_dirs }}"

    - name: Kopiere Starter in /etc/skel für neue Benutzer
      ansible.builtin.copy:
        dest: "/etc/skel/{{ item }}/uxplay-terminal.desktop"
        content: |
          [Desktop Entry]
          Type=Application
          Name=AirPlay Receiver (Terminal)
          Comment=Starte uxplay im Terminal
          Exec=gnome-terminal -- bash -c "{{ uxplay_exec }}; echo; echo 'Drücken Sie [Enter], um das Terminal zu schließen...'; read"
          Icon={{ uxplay_icon }}
          Terminal=false
          StartupNotify=true
          X-GNOME-UsesNotifications=true
          X-AppStream-Ignore=true
        mode: "0755"
      loop: "{{ desktop_dirs }}"
